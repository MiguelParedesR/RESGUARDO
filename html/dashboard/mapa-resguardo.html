?<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seguimiento de Custodia</title>
  <link rel="icon" href="/assets/icon-192.svg" type="image/svg\+xml">

  <!-- MDL -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css" />
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin />
  <link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin />
  <link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin />
  <link rel="manifest" href="/manifest.json" /><!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Estilos -->
  <link rel="stylesheet" href="../../css/dashboard/mapa-resguardo.css" />
  <link rel="stylesheet" href="../../css/partials/app-header.css" />
  <link rel="stylesheet" href="../../modules/alarma/alarma.css" />

  <!-- Supabase (CDN) ANTES de config.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="../../config.js"></script>

  <!-- Protección + Lógica -->
  <script defer src="../../modules/alarma/alarma.js"></script>
  <script defer src="../../js/lib/router-local.js"></script>
  <script defer src="../../js/lib/app-header.js"></script>
  <script defer src="../../js/lib/custodia-session.js"></script>
  <script defer src="../../js/mapa.js"></script>
  <script defer src="../../js/pwa.js"></script>
</head>

<body class="mdl-base">
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <div id="app-header" data-page-title="Seguimiento de Custodia"></div>

    <main class="mdl-layout__content">
      <section class="page">
        <button id="alarma-panic-btn" class="alarma-panic-btn" type="button" title="Boton de Panico"
          aria-label="Boton de Panico">
          <span class="alarma-panic-btn__icon"></span>
          <span class="alarma-panic-btn__label">Boton de Panico</span>
        </button>
        <div class="topbar">
          <button id="btn-finalizar" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" disabled>
            Servicio Finalizado
          </button>
          <button id="btn-custodias-mobile" class="mdl-button mdl-js-button mdl-button--raised">Custodias +</button>
          <div class="metrics">
            <span><strong>Distancia:</strong> <span id="distancia-label">--</span></span>
          </div>
        </div>

        <div class="layout-track">
          <aside id="custodios-sidebar" class="cust-sidebar">
            <div class="cust-head">
              <h3>Custodios</h3>
              <div class="cust-head__actions">
                <button id="custodios-add" class="add-btn" title="Agregar">+</button>
                <button id="custodios-close" class="cust-close" title="Cerrar listado">
                  <i class="material-icons" aria-hidden="true">close</i>
                </button>
              </div>
            </div>
            <div id="custodios-list" class="cust-list"></div>
          </aside>
          <div class="map-wrap with-sidebar">
            <div id="map-track"></div>
            <div class="panel show">
              <p><strong>Destino:</strong> <span id="destino-texto">Cargando..</span></p>
              <p><strong>Estado:</strong> <span id="estado-texto">EN CURSO</span></p>
            </div>
          </div>
        </div>
      </section>

      <div id="custodios-overlay" class="cust-overlay" hidden></div>

      <div id="app-snackbar" class="mdl-js-snackbar mdl-snackbar">
        <div class="mdl-snackbar__text"></div>
        <button class="mdl-snackbar__action" type="button"></button>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const servicioId = sessionStorage.getItem('servicio_id_actual');
      const destinoEl = document.getElementById('destino-texto');
      const estadoEl = document.getElementById('estado-texto');

      if (!servicioId || !window.sb) { destinoEl.textContent = '—'; estadoEl.textContent = '—'; return; }

      try {
        const { data, error } = await window.sb
          .from('servicio')
          .select('destino_texto, estado')
          .eq('id', servicioId)
          .single();

        if (error) throw error;

        destinoEl.textContent = data?.destino_texto || '—';
        estadoEl.textContent = data?.estado || 'EN CURSO';
        estadoEl.style.color = (data?.estado === 'FINALIZADO') ? '#2e7d32' : '#f57c00';
      } catch (err) {
        console.error('[mapa-resguardo] error', err);
        destinoEl.textContent = '—';
        estadoEl.textContent = '—';
      }
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const servicioId = sessionStorage.getItem('servicio_id_actual');
      if (!servicioId || !window.sb) return;
      // === BEGIN HU:HU-CUSTODIA-UPDATE-FIX (NO TOCAR FUERA) ===
      async function updateCustodia({ scId, nombre, tipo }) {
        try {
          if (!scId) throw new Error('scId requerido');
          const payload = {};
          if (typeof nombre === 'string' && nombre.trim()) payload.nombre_custodio = nombre.trim();
          if (typeof tipo === 'string' && tipo.trim()) payload.tipo_custodia = tipo.trim();
          if (!Object.keys(payload).length) {
            console.log('[custodia-update] skip', { sc_id: scId });
            return { ok: true, data: null };
          }
          const scFilter = String(scId).trim();
          console.log('[custodia-update] start', { sc_id: scFilter, payload });
          const { data, error, status } = await window.sb
            .from('servicio_custodio')
            .update(payload, { returning: 'representation' })
            .eq('id', scFilter)
            .select('id, servicio_id, nombre_custodio, tipo_custodia');
          console.log('[custodia-update] response', {
            scId: scFilter,
            status,
            rows: Array.isArray(data) ? data.length : data ? 1 : 0,
            data
          });
          if (error) {
            console.warn('[custodia-update] FAIL', { sc_id: scId, status, error });
            throw error;
          }
          let row = Array.isArray(data) ? data[0] : data;
          if (!row) {
            const { data: fallback, error: fetchError } = await window.sb
              .from('servicio_custodio')
              .select('id, servicio_id, nombre_custodio, tipo_custodia')
              .eq('id', scFilter)
              .maybeSingle();
            if (fetchError) throw fetchError;
            if (!fallback) throw new Error('Custodio no encontrado');
            row = fallback;
          }
          const verify = await window.sb
            .from('servicio_custodio')
            .select('id, nombre_custodio, tipo_custodia')
            .eq('id', scFilter)
            .maybeSingle();
          console.log('[custodia-update] verify', { sc_id: scFilter, verify });
          console.log('[custodia-update] OK', { sc_id: scId, servicio_id: row?.servicio_id || null });
          return { ok: true, data: row };
        } catch (err) {
          console.warn('[error]', { scope: 'mapa-resguardo/update', sc_id: scId, message: err?.message || 'unknown' });
          return { ok: false, error: err };
        }
      }
      // === END HU:HU-CUSTODIA-UPDATE-FIX ===
      // === BEGIN HU:HU-CAMERA-COMPACT-UI (NO TOCAR FUERA) ===
      async function saveSelfie(scId, blob) {
        try {
          if (!scId || !blob) throw new Error('Parametros invalidos para selfie');
          const mime = blob.type || 'image/jpeg';
          const bytes = await blobToHex(blob);
          const { data, error, status } = await window.sb
            .from('selfie')
            .insert({ servicio_custodio_id: scId, mime_type: mime, bytes }, { returning: 'representation' })
            .select('id, servicio_custodio_id, created_at')
            .single();
          if (error) {
            console.warn('[selfie] FAIL', { sc_id: scId, status, error });
            throw error;
          }
          console.log('[selfie] OK', { sc_id: scId, selfie_id: data?.id });
          return { ok: true, data };
        } catch (err) {
          console.warn('[selfie] FAIL', { sc_id: scId, message: err?.message || 'unknown' });
          return { ok: false, error: err };
        }
      }
      async function dataUrlToBlob(dataUrl) {
        if (!dataUrl?.startsWith('data:')) throw new Error('Selfie invalida');
        const res = await fetch(dataUrl);
        return await res.blob();
      }
      async function blobToHex(blob) {
        const buffer = await blob.arrayBuffer();
        const bytes = new Uint8Array(buffer);
        let hex = '';
        bytes.forEach((b) => {
          hex += b.toString(16).padStart(2, '0');
        });
        return '\\x' + hex;
      }
      // === END HU:HU-CAMERA-COMPACT-UI ===
      try {
        const listEl = document.getElementById('custodios-list');
        const { data: custodios, error } = await window.sb
          .from('servicio_custodio')
          .select('id, nombre_custodio, created_at, selfie(id)')
          .eq('servicio_id', servicioId)
          .order('id');
        if (error) throw error;
        // === BEGIN HU:HU-CUSTODIA-UPDATE-FIX (NO TOCAR FUERA) ===
        console.log('[custodia-read]', {
          scope: 'mapa-resguardo/sidebar',
          servicio_id: servicioId,
          custodios: Array.isArray(custodios) ? custodios.length : 0,
        });
        // === END HU:HU-CUSTODIA-UPDATE-FIX ===
        listEl.innerHTML = '';
        (custodios || []).forEach(c => {
          const row = document.createElement('div'); row.className = 'cust-row';
          const nm = document.createElement('span'); nm.className = 'cust-name'; nm.textContent = c.nombre_custodio || '(Sin nombre)';
          const btn = document.createElement('button'); btn.className = 'edit-btn'; btn.title = 'Editar'; btn.innerHTML = '<i class="material-icons">edit</i>';
          btn.addEventListener('click', () => openEdit(c));
          row.appendChild(nm); row.appendChild(btn); listEl.appendChild(row);
        });
      } catch (e) {
        // === BEGIN HU:HU-CUSTODIA-UPDATE-FIX (NO TOCAR FUERA) ===
        console.error('[error]', {
          scope: 'mapa-resguardo/sidebar',
          message: e?.message || 'unknown',
        });
        // === END HU:HU-CUSTODIA-UPDATE-FIX ===
        console.error('[sidebar custodios]', e);
      }

      let mediaStream = null, selfieDataUrl = null;
      function stopCam() {
        try { if (mediaStream) mediaStream.getTracks().forEach(t => t.stop()); } catch { }
        mediaStream = null;
        selfieDataUrl = null;
      }

      function syncTextfield(inputEl) {
        if (!inputEl) return;
        const wrapper = inputEl.closest(".mdl-textfield");
        if (!wrapper) return;
        if (inputEl.value && String(inputEl.value).trim()) wrapper.classList.add('is-dirty');
        else wrapper.classList.remove('is-dirty');
        if (window.componentHandler && wrapper.classList.contains('mdl-js-textfield')) {
          try { componentHandler.upgradeElement(wrapper); } catch { }
        }
      }
      document.addEventListener('input', (event) => {
        if (event.target?.classList?.contains('mdl-textfield__input')) {
          syncTextfield(event.target);
        }
      }, true);
      document.addEventListener('change', (event) => {
        if (event.target?.classList?.contains('mdl-textfield__input')) {
          syncTextfield(event.target);
        }
      }, true);
      function openCustodiosSidebar() {
        if (!sidebarEl) return;
        sidebarEl.classList.add('is-open');
        if (overlayEl) {
          overlayEl.removeAttribute('hidden');
          overlayEl.classList.add('show');
        }
      }
      function closeCustodiosSidebar() {
        if (!sidebarEl) return;
        sidebarEl.classList.remove('is-open');
        if (overlayEl) {
          overlayEl.classList.remove('show');
          overlayEl.setAttribute('hidden', 'hidden');
        }
      }
      // Agregar custodio
      function openAdd() {
        selfieDataUrl = null;
        const modal = document.createElement('div'); modal.className = 'add-modal';
        modal.innerHTML = `
        <div class="inner">
          <h4>Agregar custodio</h4>
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:100%">
            <input class="mdl-textfield__input" type="text" id="am-nombre">
            <label class="mdl-textfield__label" for="am-nombre">Nombre del custodio</label>
          </div>
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:100%">
            <select class="mdl-textfield__input" id="am-tipo">
              <option value="" disabled selected>Seleccione tipo</option>
              <option value="Simple">Custodia Simple</option>
              <option value="Tipo A">Custodia Tipo A</option>
              <option value="Tipo B">Custodia Tipo B</option>
            </select>
            <label class="mdl-textfield__label" for="am-tipo">Tipo de custodia</label>
          </div>
          <div class="camara">
            <!-- === BEGIN HU:HU-CAMERA-COMPACT-UI (NO TOCAR FUERA) === -->
            <div class="selfie-compact">
              <button type="button" class="selfie-trigger" id="am-start" data-action="start" title="Iniciar camara">
                <i class="material-icons" aria-hidden="true">photo_camera</i>
              </button>
              <img id="am-preview" class="selfie-thumb" alt="Selfie tomada" hidden />
              <p class="selfie-hint">Presiona el botón para habilitar la cámara y captura la selfie.</p>
            </div>
            <!-- === END HU:HU-CAMERA-COMPACT-UI === -->
            <div class="cam-actions">
              <button type="button" class="cam-action cam-action--primary" id="am-shot" data-action="capture" title="Tomar selfie" disabled>
                <i class="material-icons" aria-hidden="true">photo_camera</i>
                <span>Capturar</span>
              </button>
              <button type="button" class="cam-action" id="am-reset" data-action="retry" title="Repetir selfie" disabled>
                <i class="material-icons" aria-hidden="true">autorenew</i>
                <span>Repetir</span>
              </button>
            </div>
            <p id="am-status" class="cam-estado" aria-live="polite"></p>
            <div class="cam-media">
              <video id="am-video" playsinline autoplay muted></video>
              <canvas id="am-canvas"></canvas>
            </div>
          </div>
          <div class="row-actions">
            <button id="am-save" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">Guardar</button>
            <button id="am-cancel" class="mdl-button mdl-js-button">Cancelar</button>
          </div>
        </div>`;
        document.body.appendChild(modal);
        if (window.componentHandler && typeof componentHandler.upgradeDom === 'function') {
          try { componentHandler.upgradeDom(); } catch { }
        }
        const amNombre = modal.querySelector('#am-nombre');
        const amTipo = modal.querySelector('#am-tipo');
        const amStart = modal.querySelector('#am-start');
        const amShot = modal.querySelector('#am-shot');
        const amReset = modal.querySelector('#am-reset');
        const amStatus = modal.querySelector('#am-status');
        const amVideo = modal.querySelector('#am-video');
        const amCanvas = modal.querySelector('#am-canvas');
        const amPreview = modal.querySelector('#am-preview');
        const amSave = modal.querySelector('#am-save');
        const amCancel = modal.querySelector('#am-cancel');

        syncTextfield(amNombre);
        syncTextfield(amTipo);
        amNombre.addEventListener('input', () => syncTextfield(amNombre));
        amTipo.addEventListener('change', () => syncTextfield(amTipo));

        amStart.addEventListener('click', async () => {
          try {
            amStart.disabled = true;
            amStatus.textContent = 'Solicitando permisos...';
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
            amVideo.srcObject = mediaStream;
            amVideo.style.display = 'block';
            amPreview.classList.remove('show');
          amPreview.setAttribute('hidden', 'hidden');
            amShot.disabled = false;
            amReset.disabled = true;
            amStatus.textContent = 'Camara lista';
          } catch {
            amStatus.textContent = 'No se pudo acceder a la camara';
            amStart.disabled = false;
          }
        });
        amShot.addEventListener('click', () => {
          if (!mediaStream) return;
          const w = amVideo.videoWidth || 640;
          const h = amVideo.videoHeight || 480;
          amCanvas.width = w;
          amCanvas.height = h;
          const ctx = amCanvas.getContext('2d');
          ctx.drawImage(amVideo, 0, 0, w, h);
          selfieDataUrl = amCanvas.toDataURL('image/jpeg', 0.85);
          amPreview.src = selfieDataUrl;
          amPreview.classList.add('show');
          amPreview.removeAttribute('hidden');
          amVideo.style.display = 'none';
          amShot.disabled = true;
          amReset.disabled = false;
          amStatus.textContent = 'Selfie capturada';
        });
        amReset.addEventListener('click', () => {
          if (!mediaStream) return;
          selfieDataUrl = null;
          amPreview.classList.remove('show');
          amPreview.setAttribute('hidden', 'hidden');
          amVideo.style.display = 'block';
          amShot.disabled = false;
          amReset.disabled = true;
          amStatus.textContent = 'Listo para tomar otra';
        });

        function cleanup() {
          stopCam();
          try { document.body.removeChild(modal); } catch { }
        }

        async function saveAndClose() {
          const nombre = (amNombre.value || '').trim();
          if (!nombre) { alert('Ingrese un nombre'); return; }
          const tipo = (amTipo.value || '').trim();
          if (!tipo) { alert('Seleccione el tipo de custodia'); return; }
          try {
            const { data: cId, error: errC } = await window.sb.rpc('agregar_custodio', { p_servicio_id: servicioId, p_nombre: nombre, p_tipo_custodia: tipo });
            if (errC) throw errC;
            if (selfieDataUrl) {
              const selfieBlob = await dataUrlToBlob(selfieDataUrl);
              const selfieResult = await saveSelfie(cId, selfieBlob);
              if (!selfieResult.ok) throw selfieResult.error;
            }
            cleanup();
            location.reload();
          } catch (e) {
            console.error('[error]', { scope: 'mapa-resguardo/add', message: e?.message || 'unknown' });
            console.error(e); alert('Error al agregar custodio');
          }
        }
        amSave.addEventListener('click', saveAndClose);
        amCancel.addEventListener('click', cleanup);
      }      // Botones: sidebar y movil
      const sidebarEl = document.getElementById('custodios-sidebar');
      const overlayEl = document.getElementById('custodios-overlay');
      const mobileBtn = document.getElementById('btn-custodias-mobile');
      const closeBtn = document.getElementById('custodios-close');
      try { document.getElementById('custodios-add')?.addEventListener('click', openAdd); } catch { }
      try {
        mobileBtn?.addEventListener('click', openCustodiosSidebar);
        closeBtn?.addEventListener('click', closeCustodiosSidebar);
        overlayEl?.addEventListener('click', closeCustodiosSidebar);
        window.addEventListener('resize', () => {
          if (window.innerWidth >= 980) closeCustodiosSidebar();
        });
      } catch { }
      function openEdit(c) {
        selfieDataUrl = null;
        const modal = document.createElement('div'); modal.className = 'edit-modal';
        modal.innerHTML = `
        <div class="inner">
          <h4>Editar custodio</h4>
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:100%">
            <input class="mdl-textfield__input" type="text" id="em-nombre" value="${c.nombre_custodio || ''}">
            <label class="mdl-textfield__label" for="em-nombre">Nombre del custodio</label>
          </div>
          <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label" style="width:100%">
            <select class="mdl-textfield__input" id="em-tipo">
              <option value="" disabled selected>Seleccione tipo</option>
              <option value="Simple">Custodia Simple</option>
              <option value="Tipo A">Custodia Tipo A</option>
              <option value="Tipo B">Custodia Tipo B</option>
            </select>
            <label class="mdl-textfield__label" for="em-tipo">Tipo de custodia</label>
          </div>
          <div class="camara">
            <!-- === BEGIN HU:HU-CAMERA-COMPACT-UI (NO TOCAR FUERA) === -->
            <div class="selfie-compact">
              <button type="button" class="selfie-trigger" id="em-start" data-action="start" title="Iniciar camara">
                <i class="material-icons" aria-hidden="true">photo_camera</i>
              </button>
              <img id="em-preview" class="selfie-thumb" alt="Selfie tomada" hidden />
              <p class="selfie-hint">Captura o actualiza la selfie del custodio.</p>
            </div>
            <!-- === END HU:HU-CAMERA-COMPACT-UI === -->
            <div class="cam-actions">
              <button type="button" class="cam-action cam-action--primary" id="em-shot" data-action="capture" title="Tomar selfie" disabled>
                <i class="material-icons" aria-hidden="true">photo_camera</i>
                <span>Capturar</span>
              </button>
              <button type="button" class="cam-action" id="em-reset" data-action="retry" title="Repetir selfie" disabled>
                <i class="material-icons" aria-hidden="true">autorenew</i>
                <span>Repetir</span>
              </button>
            </div>
            <p id="em-status" class="cam-estado" aria-live="polite"></p>
            <div class="cam-media">
              <video id="em-video" playsinline autoplay muted></video>
              <canvas id="em-canvas"></canvas>
            </div>
          </div>
          <div class="row-actions">
            <button id="em-save" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent">Guardar</button>
            <button id="em-cancel" class="mdl-button mdl-js-button">Cancelar</button>
          </div>
        </div>`;
        document.body.appendChild(modal);
        if (window.componentHandler && typeof componentHandler.upgradeDom === 'function') {
          try { componentHandler.upgradeDom(); } catch { }
        }
        const emNombre = modal.querySelector('#em-nombre');
        const emTipo = modal.querySelector('#em-tipo');
        const emStart = modal.querySelector('#em-start');
        const emShot = modal.querySelector('#em-shot');
        const emReset = modal.querySelector('#em-reset');
        const emStatus = modal.querySelector('#em-status');
        const emVideo = modal.querySelector('#em-video');
        const emCanvas = modal.querySelector('#em-canvas');
        const emPreview = modal.querySelector('#em-preview');
        const emSave = modal.querySelector('#em-save');
        const emCancel = modal.querySelector('#em-cancel');

        if (emTipo) {
          emTipo.value = c.tipo_custodia || '';
          if (!emTipo.value) emTipo.selectedIndex = 0;
        }

        syncTextfield(emNombre);
        syncTextfield(emTipo);
        emNombre.addEventListener('input', () => syncTextfield(emNombre));
        if (emTipo) emTipo.addEventListener('change', () => syncTextfield(emTipo));

        emStart.addEventListener('click', async () => {
          try {
            emStart.disabled = true;
            emStatus.textContent = 'Solicitando permisos...';
            mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
            emVideo.srcObject = mediaStream;
            emVideo.style.display = 'block';
            emPreview.classList.remove('show');
          emPreview.setAttribute('hidden', 'hidden');
            emShot.disabled = false;
            emReset.disabled = true;
            emStatus.textContent = 'Camara lista';
          } catch {
            emStatus.textContent = 'No se pudo acceder a la camara';
            emStart.disabled = false;
          }
        });
        emShot.addEventListener('click', () => {
          if (!mediaStream) return;
          const w = emVideo.videoWidth || 640;
          const h = emVideo.videoHeight || 480;
          emCanvas.width = w;
          emCanvas.height = h;
          const ctx = emCanvas.getContext('2d');
          ctx.drawImage(emVideo, 0, 0, w, h);
          selfieDataUrl = emCanvas.toDataURL('image/jpeg', 0.85);
          emPreview.src = selfieDataUrl;
          emPreview.classList.add('show');
          emPreview.removeAttribute('hidden');
          emVideo.style.display = 'none';
          emShot.disabled = true;
          emReset.disabled = false;
          emStatus.textContent = 'Selfie capturada';
        });
        emReset.addEventListener('click', () => {
          if (!mediaStream) return;
          selfieDataUrl = null;
          emPreview.classList.remove('show');
          emPreview.setAttribute('hidden', 'hidden');
          emVideo.style.display = 'block';
          emShot.disabled = false;
          emReset.disabled = true;
          emStatus.textContent = 'Listo para tomar otra';
        });

        function cleanup() {
          stopCam();
          try { document.body.removeChild(modal); } catch { }
        }

        async function saveAndClose() {
          const nombre = (emNombre.value || '').trim();
          if (!nombre) { alert('Ingrese nombre'); return; }
          const tipo = emTipo ? (emTipo.value || '').trim() : '';
          if (!tipo) { alert('Seleccione el tipo de custodia'); return; }
          try {
            const updateResult = await updateCustodia({ scId: c.id, nombre, tipo });
            if (!updateResult.ok) throw updateResult.error;
            if (selfieDataUrl) {
              const selfieBlob = await dataUrlToBlob(selfieDataUrl);
              const selfieResult = await saveSelfie(c.id, selfieBlob);
              if (!selfieResult.ok) throw selfieResult.error;
            }
            cleanup();
            location.reload();
          } catch (e) {
            console.error('[error]', { scope: 'mapa-resguardo/edit', message: e?.message || 'unknown' });
            console.error(e); alert('Error al guardar');
          }
        }
        emSave.addEventListener('click', saveAndClose);
        emCancel.addEventListener('click', cleanup);
      }
    });
  </script>
</body>

</html>

